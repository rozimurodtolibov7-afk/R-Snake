<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-SANTA: Deluxe Edition</title>
    <style>
        :root { --red: #ff3333; --gold: #ffd700; --green: #2ecc71; --dark: #010811; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--dark); color: white; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }

        canvas#snowCanvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1; }

        #top-bar { position: fixed; top: 15px; width: 100%; display: flex; justify-content: center; z-index: 1000; }
        .rc-panel { 
            background: rgba(255,255,255,0.1); padding: 10px 30px; border-radius: 50px; 
            border: 2px solid var(--gold); font-size: 26px; font-weight: bold; color: var(--gold);
            backdrop-filter: blur(10px); box-shadow: 0 0 20px rgba(255,215,0,0.4);
        }

        #stage { height: 55vh; display: flex; align-items: center; justify-content: center; position: relative; z-index: 5; }
        .tree-svg { width: 320px; filter: drop-shadow(0 0 25px var(--green)); }
        .toy-on-tree { position: absolute; font-size: 50px; cursor: grab; z-index: 100; user-select: none; }

        /* Notification System */
        #notify-pop { 
            position: fixed; top: -120px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.15); backdrop-filter: blur(15px);
            padding: 20px 40px; border-radius: 30px; border: 2px solid var(--gold);
            transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 7000; text-align: center;
        }
        #notify-pop.active { top: 100px; }
        #notify-pop h1 { font-size: 60px; margin: 0; }
        #notify-pop p { margin: 5px 0 0; font-weight: bold; color: var(--gold); }

        #menu { 
            height: 45vh; background: linear-gradient(to top, #000, #001a33); 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 25px; 
            border-radius: 40px 40px 0 0; border-top: 1px solid rgba(255,255,255,0.2); position: relative; z-index: 1000;
        }
        .btn { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: white; border-radius: 25px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .btn b { font-size: 45px; margin-bottom: 5px; }
        .btn:active { transform: scale(0.92); background: rgba(255,255,255,0.15); }
        .btn-gift { background: linear-gradient(45deg, #ff4d4d, #c0392b) !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,77,77,0.7); } 70% { box-shadow: 0 0 0 15px rgba(255,77,77,0); } 100% { box-shadow: 0 0 0 0 rgba(255,77,77,0); } }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 5000; display: none; padding: 25px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .card { background: #0a1122; padding: 15px; border-radius: 20px; text-align: center; border: 1px solid #222; }
        .card h1 { font-size: 55px; margin: 5px 0; }
        .buy-btn { width: 100%; border: none; background: var(--gold); padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; color: #000; }
        .close-btn { float: right; font-size: 40px; color: var(--red); cursor: pointer; }
    </style>
</head>
<body>

<canvas id="snowCanvas"></canvas>

<div id="notify-pop">
    <h1 id="notify-emoji">üéÖ</h1>
    <p id="notify-text">GIFT COLLECTED!</p>
</div>

<div id="top-bar">
    <div class="rc-panel">üí∞ <span id="rc-val">100</span> RC</div>
</div>

<div id="stage">
    <svg class="tree-svg" viewBox="0 0 200 260">
        <polygon points="100,10 180,110 20,110" fill="#2ecc71" />
        <polygon points="100,60 190,170 10,170" fill="#27ae60" />
        <polygon points="100,110 200,240 0,240" fill="#1e8449" />
        <rect x="85" y="240" width="30" height="20" fill="#5d4037" />
        <circle cx="100" cy="10" r="8" fill="#ffd700" />
    </svg>
</div>

<div id="menu">
    <button class="btn" onclick="openModal('shop')"><b>üõí</b>Shop</button>
    <button class="btn" onclick="openModal('chest')"><b>üì¶</b>Chest</button>
    <button class="btn btn-gift" onclick="getGift()"><b>üéÅ</b>GIFT</button>
    <button class="btn" onclick="toggleMusic()"><b>üéµ</b>Music: <span id="m-status">OFF</span></button>
</div>

<div id="modal-shop" class="modal">
    <span class="close-btn" onclick="closeModal()">√ó</span>
    <h2 style="color:var(--gold)">Christmas Market</h2>
    <div class="grid" id="shop-list"></div>
</div>

<div id="modal-chest" class="modal">
    <span class="close-btn" onclick="closeModal()">√ó</span>
    <h2 style="color:var(--green)">My Decorations</h2>
    <div class="grid" id="chest-list"></div>
</div>

<script>
    let db = { rc: 100, inventory: ['‚≠ê'] };
    let musicOn = false;
    let audioCtx;
    let musicLoopTimeout;

    const shopItems = [
        {e:'üî¥', p:20}, {e:'üîµ', p:20}, {e:'üü°', p:20}, {e:'üü¢', p:20},
        {e:'üîî', p:50}, {e:'üç≠', p:40}, {e:'‚ùÑÔ∏è', p:60}, {e:'üåü', p:100},
        {e:'üç¶', p:80}, {e:'üç™', p:45}, {e:'üéÅ', p:150}, {e:'ü¶å', p:300},
        {e:'‚õÑ', p:250}, {e:'üéÑ', p:400}, {e:'üïØÔ∏è', p:90}, {e:'‚ú®', p:120},
        {e:'üéÄ', p:70}, {e:'üíé', p:1000}
    ];

    function notify(emoji, text) {
        const pop = document.getElementById('notify-pop');
        document.getElementById('notify-emoji').innerText = emoji;
        document.getElementById('notify-text').innerText = text;
        pop.classList.add('active');
        setTimeout(() => pop.classList.remove('active'), 2500);
    }

    function toggleMusic() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        musicOn = !musicOn;
        document.getElementById('m-status').innerText = musicOn ? "ON" : "OFF";
        
        if(musicOn) {
            playFullMelody();
        } else {
            // Stop music by clearing timeout
            clearTimeout(musicLoopTimeout);
        }
    }

    function playNote(freq, dur, startTime) {
        if(!musicOn && freq > 0) return; // Only play if music is on, except for system sounds
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        osc.start(audioCtx.currentTime + startTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + startTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + startTime + dur);
        osc.stop(audioCtx.currentTime + startTime + dur);
    }

    function playFullMelody() {
        if(!musicOn) return;
        const jingle = [
            {f:659, d:0.3}, {f:659, d:0.3}, {f:659, d:0.6}, 
            {f:659, d:0.3}, {f:659, d:0.3}, {f:659, d:0.6}, 
            {f:659, d:0.3}, {f:783, d:0.3}, {f:523, d:0.3}, {f:587, d:0.3}, {f:659, d:1.0}, 
            {f:698, d:0.3}, {f:698, d:0.3}, {f:698, d:0.3}, {f:698, d:0.3}, {f:698, d:0.3}, 
            {f:659, d:0.3}, {f:659, d:0.3}, {f:659, d:0.15}, {f:659, d:0.15}, 
            {f:783, d:0.3}, {f:783, d:0.3}, {f:698, d:0.3}, {f:587, d:0.3}, {f:523, d:0.8} 
        ];
        
        let time = 0;
        jingle.forEach(n => {
            if(musicOn) playNote(n.f, n.d + 0.2, time);
            time += n.d + 0.05;
        });

        musicLoopTimeout = setTimeout(() => { 
            if(musicOn) playFullMelody(); 
        }, time * 1000 + 1000);
    }

    function getGift() {
        db.rc += 10;
        updateRC();
        notify("üéÖ", "HO-HO-HO! +10 RC");
        if(audioCtx) playNote(880, 0.2, 0); 
    }

    function openModal(id) { document.getElementById('modal-' + id).style.display = 'block'; render(id); }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    function render(id) {
        let html = '';
        if(id === 'shop') {
            shopItems.forEach(i => html += `<div class="card"><h1>${i.e}</h1><p>${i.p} RC</p><button class="buy-btn" onclick="buy('${i.e}', ${i.p})">BUY</button></div>`);
            document.getElementById('shop-list').innerHTML = html;
        } else {
            db.inventory.forEach(i => html += `<div class="card" onclick="placeToy('${i}')"><h1>${i}</h1><p>ADD</p></div>`);
            document.getElementById('chest-list').innerHTML = html;
        }
    }

    function buy(e, p) {
        if(db.rc >= p) {
            db.rc -= p; db.inventory.push(e);
            updateRC(); 
            render('shop');
            closeModal(); // Option to close shop and show item
            notify(e, "ITEM PURCHASED!");
        } else alert("Not enough RC!");
    }

    function placeToy(emoji) {
        const toy = document.createElement('div');
        toy.className = 'toy-on-tree';
        toy.innerText = emoji;
        toy.style.left = '50%'; toy.style.top = '30%';
        
        let isDragging = false;
        const move = (e) => {
            if (!isDragging) return;
            let x = (e.touches ? e.touches[0].clientX : e.clientX);
            let y = (e.touches ? e.touches[0].clientY : e.clientY);
            toy.style.left = (x - 25) + 'px';
            toy.style.top = (y - 25) + 'px';
        };
        toy.addEventListener('mousedown', () => isDragging = true);
        toy.addEventListener('touchstart', () => isDragging = true);
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('touchend', () => isDragging = false);
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', move);

        document.getElementById('stage').appendChild(toy);
        closeModal();
    }

    const canvas = document.getElementById('snowCanvas');
    const ctx = canvas.getContext('2d');
    let flakes = [];
    function initSnow() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        for(let i=0; i<80; i++) flakes.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*3+1, s:Math.random()*2+1});
    }
    function drawSnow() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "white";
        ctx.beginPath();
        flakes.forEach(f => {
            ctx.moveTo(f.x, f.y);
            ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
            f.y += f.s; if(f.y > canvas.height) f.y = -5;
        });
        ctx.fill();
        requestAnimationFrame(drawSnow);
    }
    initSnow(); drawSnow();

    function updateRC() { document.getElementById('rc-val').innerText = db.rc; }
    updateRC();
</script>
</body>
</html>